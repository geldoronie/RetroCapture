# Usar imagem especializada dockcross/windows-x64
# Esta imagem j√° tem MXE configurado em /usr/src/mxe
FROM dockcross/windows-x64:latest

# A imagem dockcross j√° tem:
# - MXE em /usr/src/mxe
# - MinGW-w64 compilador
# - CMake configurado

# Compilar depend√™ncias usando o MXE que j√° vem no dockcross
RUN cd /usr/src/mxe && \
    echo "üî® Compilando GLFW..." && \
    make -j$(nproc) glfw3 MXE_TARGETS=x86_64-w64-mingw32.static && \
    echo "üî® Compilando OpenSSL..." && \
    make -j$(nproc) openssl MXE_TARGETS=x86_64-w64-mingw32.static && \
    echo "üî® Compilando libpng..." && \
    make -j$(nproc) libpng MXE_TARGETS=x86_64-w64-mingw32.static && \
    echo "‚úÖ Depend√™ncias compiladas"

# Remover 'lame' do FFmpeg se necess√°rio
RUN cd /usr/src/mxe && \
    if [ -f src/ffmpeg.mk ]; then \
    sed -i 's/ lame / /g' src/ffmpeg.mk && \
    sed -i '/--enable-libmp3lame/d' src/ffmpeg.mk; \
    fi && \
    echo "üî® Compilando FFmpeg..." && \
    make -j$(nproc) ffmpeg MXE_TARGETS=x86_64-w64-mingw32.static || \
    echo "‚ö†Ô∏è  FFmpeg opcional"

# Script de build
COPY docker-build-windows.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-build-windows.sh

WORKDIR /work

ENTRYPOINT ["/usr/local/bin/docker-build-windows.sh"]
