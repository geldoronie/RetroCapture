# Usar imagem especializada dockcross/windows-x64
# Esta imagem jÃ¡ tem MXE configurado em /usr/src/mxe
FROM dockcross/windows-x64:latest

# A imagem dockcross jÃ¡ tem:
# - MXE em /usr/src/mxe
# - MinGW-w64 compilador
# - CMake configurado

# Compilar dependÃªncias usando o MXE que jÃ¡ vem no dockcross
RUN cd /usr/src/mxe && \
    echo "ðŸ”¨ Compilando GLFW..." && \
    make -j$(nproc) glfw3 MXE_TARGETS=x86_64-w64-mingw32.static && \
    echo "ðŸ”¨ Compilando OpenSSL..." && \
    make -j$(nproc) openssl MXE_TARGETS=x86_64-w64-mingw32.static && \
    echo "ðŸ”¨ Compilando libpng..." && \
    make -j$(nproc) libpng MXE_TARGETS=x86_64-w64-mingw32.static && \
    echo "âœ… DependÃªncias compiladas"

# Remover 'lame' do FFmpeg se necessÃ¡rio
RUN cd /usr/src/mxe && \
    if [ -f src/ffmpeg.mk ]; then \
    sed -i 's/ lame / /g' src/ffmpeg.mk && \
    sed -i '/--enable-libmp3lame/d' src/ffmpeg.mk; \
    fi && \
    echo "ðŸ”¨ Compilando FFmpeg..." && \
    make -j$(nproc) ffmpeg MXE_TARGETS=x86_64-w64-mingw32.static || \
    echo "âš ï¸  FFmpeg opcional"

# Instalar NSIS para gerar instaladores Windows
# Debian Jessie estÃ¡ EOL, entÃ£o precisamos usar archive.debian.org
# As chaves GPG expiraram, entÃ£o precisamos permitir pacotes nÃ£o autenticados
RUN echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until && \
    echo 'APT::Get::AllowUnauthenticated "true";' > /etc/apt/apt.conf.d/99allow-unauthenticated && \
    sed -i 's|http://.*debian.org|http://archive.debian.org|g' /etc/apt/sources.list && \
    sed -i 's|http://security.debian.org|http://archive.debian.org/debian-security|g' /etc/apt/sources.list && \
    sed -i '/jessie-updates/d' /etc/apt/sources.list && \
    sed -i '/jessie-backports/d' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y --allow-unauthenticated nsis && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    echo "âœ… NSIS instalado para geraÃ§Ã£o de instaladores"

# Script de build
COPY docker-build-windows.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-build-windows.sh

WORKDIR /work

ENTRYPOINT ["/usr/local/bin/docker-build-windows.sh"]
